# Taba 기능명세서

## 1. 인증 (Authentication)

### 1.1 회원가입
- **엔드포인트**: `POST /api/auth/signup`
- **요청 파라미터**:
  - `email`: String (이메일)
  - `password`: String (비밀번호)
  - `nickname`: String (닉네임)
  - `agreeTerms`: Boolean (이용약관 동의)
  - `agreePrivacy`: Boolean (개인정보처리방침 동의)
- **응답**: 
  - `userId`: String
  - `token`: String (JWT)
- **비즈니스 로직**:
  - 이메일 중복 체크
  - 비밀번호 암호화 (BCrypt)
  - 이용약관 및 개인정보처리방침 동의 필수
  - 초기 프로필 생성

### 1.2 로그인
- **엔드포인트**: `POST /api/auth/login`
- **요청 파라미터**:
  - `email`: String
  - `password`: String
- **응답**:
  - `token`: String (JWT)
  - `user`: UserDto
- **비즈니스 로직**:
  - 이메일/비밀번호 검증
  - JWT 토큰 발급
  - 로그인 이력 기록

### 1.3 비밀번호 찾기
- **엔드포인트**: `POST /api/auth/forgot-password`
- **요청 파라미터**:
  - `email`: String
- **응답**: 
  - `message`: String
- **비즈니스 로직**:
  - 이메일 존재 여부 확인
  - 비밀번호 재설정 링크 이메일 발송
  - 재설정 토큰 생성 (유효기간 1시간)

### 1.4 비밀번호 재설정
- **엔드포인트**: `POST /api/auth/reset-password`
- **요청 파라미터**:
  - `token`: String (재설정 토큰)
  - `newPassword`: String
- **응답**: 
  - `message`: String
- **비즈니스 로직**:
  - 토큰 유효성 검증
  - 비밀번호 업데이트

### 1.5 비밀번호 변경
- **엔드포인트**: `PUT /api/auth/change-password`
- **인증**: Required (JWT)
- **요청 파라미터**:
  - `currentPassword`: String
  - `newPassword`: String
- **응답**: 
  - `message`: String
- **비즈니스 로직**:
  - 현재 비밀번호 검증
  - 새 비밀번호로 업데이트

## 2. 사용자 (User)

### 2.1 프로필 조회
- **엔드포인트**: `GET /api/users/{userId}`
- **인증**: Required (JWT)
- **응답**: UserDto
  - `id`: String
  - `username`: String
  - `nickname`: String
  - `avatarUrl`: String
  - `statusMessage`: String
  - `joinedAt`: DateTime
  - `friendCount`: Integer
  - `sentLetters`: Integer

### 2.2 프로필 수정
- **엔드포인트**: `PUT /api/users/{userId}`
- **인증**: Required (JWT)
- **요청 파라미터**:
  - `nickname`: String (선택)
  - `statusMessage`: String (선택)
  - `avatarUrl`: String (선택)
- **응답**: UserDto

### 2.3 로그아웃
- **엔드포인트**: `POST /api/auth/logout`
- **인증**: Required (JWT)
- **비즈니스 로직**:
  - 토큰 무효화 (블랙리스트 추가)

## 3. 편지 (Letter)

### 3.1 편지 작성
- **엔드포인트**: `POST /api/letters`
- **인증**: Required (JWT)
- **요청 파라미터**:
  - `title`: String
  - `content`: String
  - `preview`: String (미리보기 텍스트)
  - `flowerType`: Enum (ROSE, TULIP, SAKURA, SUNFLOWER, DAISY, LAVENDER)
  - `visibility`: Enum (PUBLIC, FRIENDS, DIRECT, PRIVATE)
  - `isAnonymous`: Boolean
  - `template`: LetterTemplateDto (선택)
  - `fontFamily`: String (선택)
  - `attachedImages`: List<String> (이미지 URL 리스트)
  - `scheduledAt`: DateTime (선택, 예약 발송)
  - `recipientId`: String (선택, DIRECT인 경우)
- **응답**: LetterDto
- **비즈니스 로직**:
  - 편지 생성
  - 이미지 업로드 처리 (S3 등)
  - 예약 발송인 경우 스케줄러에 등록
  - DIRECT인 경우 수신자에게 알림 발송
  - PUBLIC인 경우 하늘에 씨앗으로 표시

### 3.2 편지 목록 조회 (하늘 - 공개 편지)
- **엔드포인트**: `GET /api/letters/public`
- **인증**: Required (JWT)
- **쿼리 파라미터**:
  - `page`: Integer (기본값: 0)
  - `size`: Integer (기본값: 20)
  - `sort`: String (기본값: "sentAt,desc")
- **응답**: Page<LetterDto>
- **비즈니스 로직**:
  - PUBLIC인 편지만 조회
  - 조회수 증가
  - 랜덤 위치 계산 (화면 좌표)

### 3.3 편지 상세 조회
- **엔드포인트**: `GET /api/letters/{letterId}`
- **인증**: Required (JWT)
- **응답**: LetterDto
  - `id`: String
  - `title`: String
  - `content`: String
  - `sender`: UserDto
  - `flowerType`: Enum
  - `sentAt`: DateTime
  - `likes`: Integer
  - `views`: Integer
  - `savedCount`: Integer
  - `attachedImages`: List<String>
  - `template`: LetterTemplateDto
- **비즈니스 로직**:
  - 권한 체크 (PRIVATE인 경우 본인만, DIRECT인 경우 수신자/발신자만)
  - 조회수 증가

### 3.4 편지 좋아요
- **엔드포인트**: `POST /api/letters/{letterId}/like`
- **인증**: Required (JWT)
- **응답**: 
  - `likes`: Integer
  - `isLiked`: Boolean
- **비즈니스 로직**:
  - 중복 좋아요 방지
  - 좋아요 수 증가/감소
  - 발신자에게 알림 발송

### 3.5 편지 저장
- **엔드포인트**: `POST /api/letters/{letterId}/save`
- **인증**: Required (JWT)
- **응답**: 
  - `savedCount`: Integer
  - `isSaved`: Boolean
- **비즈니스 로직**:
  - 중복 저장 방지
  - 저장 수 증가/감소

### 3.6 편지 신고
- **엔드포인트**: `POST /api/letters/{letterId}/report`
- **인증**: Required (JWT)
- **요청 파라미터**:
  - `reason`: String
- **응답**: 
  - `message`: String
- **비즈니스 로직**:
  - 신고 내용 저장
  - 관리자 알림

### 3.7 편지 삭제
- **엔드포인트**: `DELETE /api/letters/{letterId}`
- **인증**: Required (JWT)
- **비즈니스 로직**:
  - 본인 편지만 삭제 가능
  - 첨부 이미지 삭제
  - 관련 알림 삭제

## 4. 꽃다발 (Bouquet)

### 4.1 친구 목록 조회
- **엔드포인트**: `GET /api/bouquets`
- **인증**: Required (JWT)
- **응답**: List<BouquetDto>
  - `friend`: FriendProfileDto
  - `sharedFlowers`: List<SharedFlowerDto>
  - `bloomLevel`: Double (0.0 ~ 1.0)
  - `trustScore`: Integer (0 ~ 100)
  - `bouquetName`: String
  - `unreadCount`: Integer
- **비즈니스 로직**:
  - 친구 관계 조회
  - 각 친구와의 편지 교환 내역 조회
  - 꽃다발 상태 계산 (bloomLevel, trustScore)

### 4.2 친구별 편지 목록 조회
- **엔드포인트**: `GET /api/bouquets/{friendId}/letters`
- **인증**: Required (JWT)
- **쿼리 파라미터**:
  - `page`: Integer
  - `size`: Integer
- **응답**: Page<SharedFlowerDto>
- **비즈니스 로직**:
  - 친구와 주고받은 편지만 조회
  - 시간순 정렬

### 4.3 꽃다발 이름 변경
- **엔드포인트**: `PUT /api/bouquets/{friendId}/name`
- **인증**: Required (JWT)
- **요청 파라미터**:
  - `bouquetName`: String
- **응답**: BouquetDto

### 4.4 꽃다발 공유
- **엔드포인트**: `POST /api/bouquets/{friendId}/share`
- **인증**: Required (JWT)
- **응답**: 
  - `shareUrl`: String
  - `shareText`: String
- **비즈니스 로직**:
  - 공유 링크 생성
  - 공유 텍스트 생성

## 5. 친구 (Friend)

### 5.1 친구 추가 (초대 코드로)
- **엔드포인트**: `POST /api/friends/invite`
- **인증**: Required (JWT)
- **요청 파라미터**:
  - `inviteCode`: String
- **응답**: FriendProfileDto
- **비즈니스 로직**:
  - 초대 코드 유효성 검증
  - 친구 관계 생성 (양방향)
  - 초대 코드 사용 처리

### 5.2 친구 목록 조회
- **엔드포인트**: `GET /api/friends`
- **인증**: Required (JWT)
- **응답**: List<FriendProfileDto>
- **비즈니스 로직**:
  - 친구 관계 조회
  - 친구 프로필 정보 포함

### 5.3 친구 삭제
- **엔드포인트**: `DELETE /api/friends/{friendId}`
- **인증**: Required (JWT)
- **비즈니스 로직**:
  - 친구 관계 삭제 (양방향)
  - 관련 꽃다발 데이터 유지 (히스토리 보존)

## 6. 초대 코드 (Invite Code)

### 6.1 초대 코드 생성
- **엔드포인트**: `POST /api/invite-codes/generate`
- **인증**: Required (JWT)
- **응답**: InviteCodeDto
  - `code`: String
  - `expiresAt`: DateTime
  - `remainingMinutes`: Integer
- **비즈니스 로직**:
  - 초대 코드 생성 (형식: {USERNAME}-{6자리숫자})
  - 유효기간 3분 설정
  - 기존 코드가 있으면 갱신

### 6.2 초대 코드 조회
- **엔드포인트**: `GET /api/invite-codes/current`
- **인증**: Required (JWT)
- **응답**: InviteCodeDto
- **비즈니스 로직**:
  - 현재 유효한 초대 코드 조회
  - 만료된 경우 null 반환

### 6.3 초대 코드 복사
- **엔드포인트**: `POST /api/invite-codes/copy`
- **인증**: Required (JWT)
- **응답**: 
  - `code`: String
  - `message`: String

## 7. 알림 (Notification)

### 7.1 알림 목록 조회
- **엔드포인트**: `GET /api/notifications`
- **인증**: Required (JWT)
- **쿼리 파라미터**:
  - `page`: Integer
  - `size`: Integer
  - `category`: Enum (LETTER, REACTION, FRIEND, SYSTEM)
- **응답**: Page<NotificationDto>
  - `id`: String
  - `title`: String
  - `subtitle`: String
  - `time`: DateTime
  - `category`: Enum
  - `isUnread`: Boolean
  - `relatedId`: String (관련 엔티티 ID)

### 7.2 알림 읽음 처리
- **엔드포인트**: `PUT /api/notifications/{notificationId}/read`
- **인증**: Required (JWT)
- **응답**: NotificationDto

### 7.3 알림 전체 읽음 처리
- **엔드포인트**: `PUT /api/notifications/read-all`
- **인증**: Required (JWT)
- **응답**: 
  - `message`: String
  - `readCount`: Integer

### 7.4 알림 삭제
- **엔드포인트**: `DELETE /api/notifications/{notificationId}`
- **인증**: Required (JWT)

## 8. 설정 (Settings)

### 8.1 푸시 알림 설정 조회
- **엔드포인트**: `GET /api/settings/push-notification`
- **인증**: Required (JWT)
- **응답**: 
  - `enabled`: Boolean

### 8.2 푸시 알림 설정 변경
- **엔드포인트**: `PUT /api/settings/push-notification`
- **인증**: Required (JWT)
- **요청 파라미터**:
  - `enabled`: Boolean
- **응답**: 
  - `enabled`: Boolean

### 8.3 언어 설정 조회
- **엔드포인트**: `GET /api/settings/language`
- **인증**: Required (JWT)
- **응답**: 
  - `language`: String (ko, en, ja)

### 8.4 언어 설정 변경
- **엔드포인트**: `PUT /api/settings/language`
- **인증**: Required (JWT)
- **요청 파라미터**:
  - `language`: String
- **응답**: 
  - `language`: String

## 9. 파일 업로드

### 9.1 이미지 업로드
- **엔드포인트**: `POST /api/files/upload`
- **인증**: Required (JWT)
- **요청**: MultipartFile
- **응답**: 
  - `url`: String (업로드된 이미지 URL)
  - `fileName`: String
- **비즈니스 로직**:
  - 이미지 파일 검증 (크기, 형식)
  - S3 또는 로컬 스토리지에 업로드
  - URL 반환

## 10. 스케줄러 (예약 발송)

### 10.1 예약 발송 처리
- **내부 엔드포인트**: 스케줄러에서 호출
- **비즈니스 로직**:
  - 예약된 편지 조회
  - 발송 시간 도달 시 편지 발송
  - 알림 발송
  - 스케줄 상태 업데이트

## 공통 사항

### 인증
- 모든 API는 JWT 토큰 기반 인증 사용
- 토큰은 Authorization 헤더에 Bearer 형식으로 전달
- 토큰 만료 시 401 응답

### 에러 처리
- 400: Bad Request (잘못된 요청)
- 401: Unauthorized (인증 실패)
- 403: Forbidden (권한 없음)
- 404: Not Found (리소스 없음)
- 500: Internal Server Error (서버 오류)

### 페이징
- 기본 페이지 크기: 20
- 페이지 번호는 0부터 시작
- 응답 형식:
  ```json
  {
    "content": [...],
    "page": 0,
    "size": 20,
    "totalElements": 100,
    "totalPages": 5
  }
  ```

### 날짜/시간
- ISO 8601 형식 사용
- 타임존: UTC
- 클라이언트에서 로컬 타임존으로 변환

