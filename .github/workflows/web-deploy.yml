name: Web Build & Deploy

# ì›¹ ë¹Œë“œ: release ë¸Œëœì¹˜ â†’ í”„ë¡œë•ì…˜ ì„œë²„ (www.taba.asia:80)
# SCPë¥¼ í†µí•´ ì„œë²„ì— ì§ì ‘ ë°°í¬

on:
  push:
    branches: [release]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.5'
          channel: 'stable'
      
      - name: Enable Web Support
        run: flutter config --enable-web
      
      - run: flutter pub get
      
      - name: Build Web
        run: |
          echo "ğŸŒ í”„ë¡œë•ì…˜ ì›¹ ë¹Œë“œ (ì„œë²„: https://www.taba.asia/api/v1)"
          flutter build web --release \
            --dart-define=API_ENV=prod \
            --base-href="/"
      
      - name: Upload Web Artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: build/web
          retention-days: 30
      
      - name: Deploy to Server via SCP
        if: env.SERVER_HOST != ''
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_SSH_KEY: ${{ secrets.SERVER_SSH_KEY }}
          SERVER_WEB_PATH: ${{ secrets.SERVER_WEB_PATH }}
        run: |
          # SSH í‚¤ ì„¤ì •
          mkdir -p ~/.ssh
          echo "$SERVER_SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # known_hosts ì¶”ê°€ (ì²« ì—°ê²° ì‹œ í˜¸ìŠ¤íŠ¸ í‚¤ í™•ì¸ ê±´ë„ˆë›°ê¸°)
          ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts 2>/dev/null || true
          
          # ê¸°ë³¸ ì›¹ ê²½ë¡œ ì„¤ì • (ë¹„ì–´ìˆìœ¼ë©´ /var/www/taba-web ì‚¬ìš©)
          WEB_PATH="${SERVER_WEB_PATH:-/var/www/taba-web}"
          
          echo "ğŸ“¦ ì›¹ ë¹Œë“œ íŒŒì¼ì„ $SERVER_HOST:$WEB_PATH ë¡œ ë°°í¬í•©ë‹ˆë‹¤..."
          
          # ì„œë²„ì— ë°°í¬ ë””ë ‰í† ë¦¬ ìƒì„±
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST "mkdir -p $WEB_PATH"
          
          # ê¸°ì¡´ íŒŒì¼ ë°±ì—… (ì˜µì…˜)
          ssh -i ~/.ssh/deploy_key $SERVER_USER@$SERVER_HOST "if [ -d $WEB_PATH ]; then rm -rf ${WEB_PATH}_backup; mv $WEB_PATH ${WEB_PATH}_backup 2>/dev/null || true; mkdir -p $WEB_PATH; fi"
          
          # ë¹Œë“œ íŒŒì¼ ì „ì†¡
          scp -i ~/.ssh/deploy_key -r build/web/* $SERVER_USER@$SERVER_HOST:$WEB_PATH/
          
          # í¼ë¯¸ì…˜ ì„¤ì •
          ssh -i ~/.ssh/deploy_key $SERVER_USER@$SERVER_HOST "chmod -R 755 $WEB_PATH"
          
          echo "âœ… ì›¹ ë°°í¬ ì™„ë£Œ: https://www.taba.asia"

